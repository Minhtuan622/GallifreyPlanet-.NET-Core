@using Microsoft.AspNetCore.Identity
@model GallifreyPlanet.ViewModels.AccountManager.AccountManagerViewModel

@{
    ViewData["Title"] = "Quản lý tài khoản";
    Layout = "~/Views/AccountManager/_Layout.cshtml";
}

<div class="container mt-4">
    <h2 class="mb-4 text-center">Thông tin tài khoản</h2>

    <div class="row justify-content-center">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body text-center">
                    @if (!string.IsNullOrEmpty(Model.User!.Avatar))
                    {
                        <img src="@Model.User!.Avatar" alt="Avatar" id="avatar" class="rounded-circle img-fluid mb-3" style="width: 150px;" />
                    }
                    else
                    {
                        <img src="/uploads/accounts/default-avatar.jpg" alt="Default Avatar" id="avatar" class="rounded-circle img-fluid mb-3" style="width: 150px;" />
                    }
                    <h5 class="my-3">
                        @Model.User!.Name
                        @if (User.Identity!.IsAuthenticated)
                        {
                            <i class="fa-solid fa-circle-check text-success"></i>
                        }
                    </h5>
                    <p class="text-muted mb-1">@Model.User!.UserName</p>
                    <p class="text-muted mb-4">@Model.User!.Address</p>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Thông tin cá nhân -->
                    <div class="row mb-3">
                        <div class="col-sm-3">
                            <b>Tên</b>
                        </div>
                        <div class="col-sm-9">
                            <p class="text-muted">@Model.User!.Name</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-3">
                            <b>Tên đăng nhập</b>
                        </div>
                        <div class="col-sm-9">
                            <p class="text-muted">@Model.User!.UserName</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-3">
                            <b>Số điện thoại</b>
                        </div>
                        <div class="col-sm-9">
                            <p class="text-muted">
                                @if (Model.User!.PhoneNumber != null)
                                {
                                    @Model.User!.PhoneNumber
                                }
                                else
                                {
                                    <b class="text-warning">Chưa cập nhật số điện thoại</b>
                                }
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-3">
                            <b>Email</b>
                        </div>
                        <div class="col-sm-9">
                            <p class="text-muted">@Model.User!.Email</p>
                        </div>
                    </div>

                    @if (Model.User!.Address != null)
                    {
                        <div class="row mb-3">
                            <div class="col-sm-3">
                                <b>Địa chỉ</b>
                            </div>
                            <div class="col-sm-9">
                                <p class="text-muted">@Model.User!.Address</p>
                            </div>
                        </div>
                    }

                    <div class="row">
                        <div class="col-sm-3">
                            <b>Xác thực hai yếu tố (2FA)</b>
                        </div>
                        <div class="col-sm-9">
                            @if (User.Identity!.IsAuthenticated)
                            {
                                <p class="text-success mb-0"><b>Đã bật</b></p>
                            }
                            else
                            {
                                <a asp-action="EnableTwoFactorAuthentication" class="btn btn-primary btn-sm">
                                    Bật xác thực hai yếu tố
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lịch sử đăng nhập -->
    @if (Model.LoginHistory!.Count > 0)
    {
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary-subtle">
                        <h5 class="card-title mb-0">Lịch sử đăng nhập</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Thời gian</th>
                                        <th>IP</th>
                                        <th>Thiết bị</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var login in Model.LoginHistory)
                                    {
                                        <tr>
                                            <td>@login.LoginTime.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                            <td>@login.IpAddress</td>
                                            <td>@login.UserAgent</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Phiên đăng nhập -->
    @if (Model.ActiveSessions!.Count > 0)
    {
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary-subtle">
                        <h5 class="card-title mb-0">Quản lý phiên đăng nhập</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Thiết bị</th>
                                        <th>Địa điểm</th>
                                        <th>Thời gian đăng nhập</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var session in Model.ActiveSessions)
                                    {
                                        <tr>
                                            <td>@session.DeviceName</td>
                                            <td>@session.Location</td>
                                            <td>@session.LoginTime</td>
                                            <td>
                                                <form asp-action="TerminateSession" method="post">
                                                    <input type="hidden" name="sessionId" value="@session.Id" />
                                                    <button type="submit" class="btn btn-danger btn-sm">Đăng xuất</button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>