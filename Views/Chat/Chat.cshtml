@using Humanizer
@model GallifreyPlanet.ViewModels.Chat.ChatManagerViewModel

@{
    var defaultAvatarPath = "/uploads/accounts/default-avatar.jpg";
}

<!-- Chat Main Area -->
<div class="col-md-8 col-lg-9 chat-main">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="user-info">
            @{
                var members = Model.SelectedConversation!.Members;
                if (members is not null && members.Count == 2)
                {
                    @foreach (var member in members.Where(predicate: member => member!.Id != Model.User!.Id))
                    {
                        <div class="position-relative">
                            <a asp-controller="PublicProfile" asp-action="Index" asp-route-username="@member?.UserName">
                                <img src="@(member?.Avatar ?? defaultAvatarPath)" class="rounded-circle" width="48" height="48" alt="User">
                                <span class="status-dot bg-success"></span>
                            </a>
                        </div>
                        <a asp-controller="PublicProfile" asp-action="Index" asp-route-username="@member?.UserName" class="text-decoration-none">
                            <h6 class="mb-0">@member?.Name</h6>
                            <small class="text-success">Trực tuyến</small>
                        </a>
                    }
                }
            }
        </div>
        <div class="header-actions">
            <button class="btn rounded-circle" title="Voice Call">
                <i class="fas fa-phone"></i>
            </button>
            <button class="btn rounded-circle" title="Video Call">
                <i class="fas fa-video"></i>
            </button>
            <button class="btn rounded-circle" title="More Options">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" id="messages-container">
        @if (Model.Messages is not null)
        {
            foreach (var message in Model.Messages)
            {
                @if (message.Sender!.UserName != User.Identity!.Name)
                {
                    <div class="message message-received">
                        <div class="message-content">
                            @message.Content
                        </div>
                        <span class="message-time">@message.CreatedAt.Humanize()</span>
                    </div>
                }
                else
                {
                    <div class="message message-sent">
                        <div class="message-content">
                            @message.Content
                        </div>
                        <span class="message-time">@message.CreatedAt.Humanize()</span>
                    </div>
                }
            }
        }
    </div>

    <!-- Chat Input -->
    <div class="chat-input">
        <div class="input-container">
            <button class="btn" title="Attach File">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="d-none" id="chatId" value="@Model.SelectedConversation!.Id">
            <input type="text" class="d-none" id="senderId" value="@Model.User!.Id">
            <input type="text" id="content" placeholder="Viết tin nhắn..." autocomplete="off">
            <button class="btn" title="Emoji">
                <i class="fas fa-smile"></i>
            </button>
            <button class="btn btn-primary rounded-circle" id="send-message" title="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/dist/browser/signalr.js"></script>
    <script src="~/js/chat_v2.js"></script>
}