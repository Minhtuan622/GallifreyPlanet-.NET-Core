@using Humanizer
@model GallifreyPlanet.ViewModels.Chat.ChatManagerViewModel

@{
    const string defaultAvatarPath = "/uploads/accounts/default-avatar.jpg";
}

<!-- Chat Main Area -->
<div class="col-md-8 col-lg-9 chat-main">
    <!-- Chat Header -->
    <div class="chat-header">
        @{
            var members = Model.SelectedConversation!.Members;
            if (members is not null && members.Count == 2)
            {
                @foreach (var member in members.Where(predicate: member => member!.Id != Model.User!.Id))
                {
                    <div class="user-info">
                        <div class="position-relative">
                            <a asp-controller="PublicProfile" asp-action="Index" asp-route-username="@member?.UserName">
                                <img src="@(member?.Avatar ?? defaultAvatarPath)" class="rounded-circle" width="48"
                                     height="48" alt="User">
                                <span class="status-dot bg-success"></span>
                            </a>
                        </div>
                        <a asp-controller="PublicProfile" asp-action="Index" asp-route-username="@member?.UserName"
                           class="text-decoration-none">
                            <h6 class="mb-0">@member?.Name</h6>
                            <small class="text-success">Trực tuyến</small>
                        </a>
                    </div>
                    <div class="header-actions">
                        <div class="dropdown">
                            <button class="btn btn-action" type="button" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <form asp-controller="PublicProfile" asp-action="Index" asp-route-username="@member?.UserName" method="post">
                                        <button type="submit" class="dropdown-item revoke-message">
                                            <i class="fa-regular fa-user"></i>
                                            Trang cá nhân
                                        </button>
                                    </form>
                                </li>
                                <li>
                                    <form action="" method="post">
                                        <button type="submit" class="dropdown-item revoke-message">
                                            <i class="fas fa-phone"></i>
                                            Gọi thoại
                                        </button>
                                    </form>
                                </li>
                                <li>
                                    <form action="" method="post">
                                        <button type="submit" class="dropdown-item revoke-message">
                                            <i class="fas fa-video"></i>
                                            Gọi video
                                        </button>
                                    </form>
                                </li>
                                <li>
                                    <form asp-controller="Friend" asp-action="Blocked" asp-route-username="@member?.Id" method="post">
                                        <button type="submit" class="dropdown-item revoke-message">
                                            <i class="fa-solid fa-ban"></i>
                                            Chặn
                                        </button>
                                    </form>
                                </li>
                                <li>
                                    <form asp-action="DeleteConversation" asp-route-senderId="@Model.User?.Id" asp-route-receiverId="@member?.Id" method="post">
                                        <button type="submit" class="dropdown-item revoke-message text-danger">
                                            <i class="fa-regular fa-trash-can"></i>
                                            Xóa cuộc trò chuyện
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                }
            }
        }
    </div>

    <!-- Messages Container -->
    <div class="messages-container" id="messages-container">
        @if (Model.Messages is not null)
        {
            foreach (var message in Model.Messages)
            {
                var isMessage = message.Sender!.UserName != User.Identity!.Name;
                var messageClass = isMessage ? "message-received" : "message-sent";
                messageClass += message.IsRevoked ? " revoked" : "";

                <div class="message @messageClass" data-message-id="@message.Id">
                    <div class="message-header">
                        <div class="message-content">
                            @message.Content
                        </div>
                        @if (!isMessage && !message.IsRevoked)
                        {
                            <div class="dropdown message-actions">
                                <button class="btn btn-sm btn-action" type="button" data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <button class="dropdown-item revoke-message" data-message-id="@message.Id">
                                            <i class="fas fa-undo-alt"></i> Revoke
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>
                    <span class="message-time">@message.CreatedAt.Humanize()</span>
                </div>
            }
        }
    </div>

    <!-- Chat Input -->
    <div class="chat-input">
        <div class="input-container">
            <button class="btn" title="Attach File">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="d-none" id="chatId" value="@Model.SelectedConversation!.Id">
            <input type="text" class="d-none" id="senderId" value="@Model.User!.Id">
            <input type="text" id="content" placeholder="Viết tin nhắn..." autocomplete="off">
            <button class="btn" title="Emoji">
                <i class="fas fa-smile"></i>
            </button>
            <button class="btn btn-primary rounded-circle" id="send-message" title="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/dist/browser/signalr.js"></script>
    <script src="~/js/chat_v2.js"></script>
}